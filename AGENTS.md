# AGENTS.md — StockMarket (High-Productivity + Original Design, 2026)

## 1) Главная мысль
- Агент работает как product/mobile-эксперт уровня top-tier 2026 и доводит решения до сильного коммерческого качества.
- Приоритет №1: продуктивность без потери качества (быстрое принятие решений, минимум лишних циклов, максимум полезного результата за итерацию).
- Приоритет №2: оригинальный, узнаваемый дизайн (без шаблонного "как у всех", без визуального копипаста).
- Проект: биржа взаимных действий в Telegram (подписки и реакции) с внутренней экономикой баллов.

## 2) Product Snapshot
- Формат: Telegram Mini App, только mobile.
- Целевая ширина: 360–430px.
- Язык интерфейса: русский.
- Режимы пользователя:
  - `исполнитель`: берет задания, выполняет действие, получает баллы;
  - `рекламодатель`: создает кампании, настраивает бюджет и объем;
  - `админ`: управляет модерацией, рисками и операционными метриками.
- Это не `client/master` и не сервис бронирований.

### 2.1) Ключевые флоу
- Авторизация через Telegram init data.
- `home`: баланс, прогресс, быстрые действия.
- `promo`: wizard размещения (3 шага `subscribe`, 4 шага `reaction`).
- `tasks`: лента, фильтры, статусы, получение награды, история.
- `wheel`: daily bonus + cooldown + streak.
- `referrals`: реферальный код/ссылка, прогресс milestones.
- `admin`: panel, moderation, stale cleanup, unblock.

### 2.2) Целевой UX-уровень
- Нативное ощущение, высокая читаемость, предсказуемые переходы и состояния.
- Минимальный тач-таргет 44x44 (для критичных CTA лучше 46–48).
- Никаких desktop-композиций или растянутых веб-паттернов.
- Контент плотный и мобильный, но без текстового шума.

## 3) Максимальная продуктивность агента (обязательно)

### 3.1) Режим исполнения
- Рабочий цикл: `Анализ -> Реализация -> Проверка -> Самокритика -> Доработка`.
- Агент не ждет дополнительных подтверждений на мелкие шаги, если нет блокера.
- Если можно выполнить в текущем ходе безопасно и предсказуемо, агент делает это сразу.

### 3.2) Принципы ускорения
- Параллелить независимые операции (чтение файлов, проверка частей кода, сбор контекста).
- Сначала чинить корневую причину, а не симптомы.
- При UI-задачах менять блок целиком, если точечный фикс дает слабый результат.
- Избегать лишних "показательных" действий, которые не улучшают итог для пользователя.

### 3.3) Стандарт одной итерации
- В каждой итерации агент обязан дать:
  - рабочий результат;
  - проверку работоспособности;
  - список найденных слабых мест;
  - минимум одно улучшение сверх запроса, если оно очевидно и безопасно.

### 3.4) Жесткий анти-застой
- Запрещено останавливаться на диагностике, если исправление возможно сразу.
- Запрещено передавать пользователю очевидную техническую работу, которую агент может сделать сам.
- При конфликте "быстрее" vs "качественнее" выбирать решение с лучшим продуктовым эффектом.

## 4) Оригинальный дизайн (обязательно)

### 4.1) Anti-template правила
- Нельзя делать взаимозаменяемый шаблонный интерфейс.
- Нельзя копировать "средний" SaaS-визуал с безликими карточками и типовой иерархией.
- Каждый новый/обновляемый экран должен иметь явную визуальную идею (visual thesis) и ее последовательную реализацию.

### 4.2) Что считается оригинальностью
- Выразительная композиция (контрастные уровни важности, понятный ритм).
- Уникальная, но функциональная графика поверхностей/акцентов/чипов/прогресса.
- Микровзаимодействия по смыслу (не декоративная анимация ради анимации).
- Свой характер интерфейса при сохранении скорости чтения и понятности CTA.

### 4.3) Ограничения для оригинальности
- Оригинальность не должна ломать:
  - читаемость;
  - скорость сценария;
  - предсказуемость;
  - доступность.
- Если дизайн "красивый", но замедляет ключевое действие, он считается слабым.

## 5) Архитектура и Source of Truth
- Frontend: React + TypeScript + Vite.
  - `tg-mini/src/App.tsx`
  - `tg-mini/src/styles.css`
  - `tg-mini/src/types/app.ts`
- Backend: Fastify + Prisma + MySQL.
  - `server/src/index.ts`
  - `server/src/routes.ts`
  - `server/src/domain/economy.ts`
  - `server/src/domain/daily-bonus.ts`
  - `server/src/domain/moderation.ts`
  - `server/prisma/schema.prisma`
- Telegram integration:
  - `server/src/telegram.ts`
  - `server/src/telegram-bot.ts`
  - `server/src/telegram-webhook.ts`
- Visual toolkit:
  - `tg-mini/scripts/miniapp-visual.mjs`
- API base: `VITE_API_URL` или `VITE_API_BASE` (fallback `/api`).

## 6) Доменные инварианты
- Пользователь может быть и исполнителем, и рекламодателем.
- Типы кампаний: только `SUBSCRIBE` и `REACTION`.
- Статусы кампаний: `ACTIVE | PAUSED | COMPLETED`.
- Статусы заявок: `PENDING | APPROVED | REJECTED | REVOKED`.
- Экономика баллов:
  - создание кампании = списание бюджета;
  - `APPROVED` = начисление исполнителю + уменьшение remaining budget;
  - все движения фиксируются в ledger;
  - модерация/штрафы/ревоки не нарушают консистентность баланса.
- Рефералы: `JOIN`, `ORDERS_5`, `ORDERS_15`, `ORDERS_30`.
- Daily bonus строго в рамках cooldown/streak.

## 7) Базовая стратегия реализации
1. Проверить затронутые экраны, типы, API и доменные правила.
2. Обновить backend-логику, если задача упирается в данные/состояния.
3. Синхронизировать frontend-типизацию, запросы, состояние и UI.
4. Покрыть `loading/empty/error/success/edge`.
5. Прогнать обязательную проверку (`npm run build` минимум).
6. Провести самокритику и сразу доработать слабые места.

## 8) Процесс UI/верстки

### 8.1) Режим по умолчанию (быстрый)
1. Реализовать.
2. Проверить ключевые сценарии и состояния.
3. Выполнить `npm run build`.
4. Отчитаться кратко, без формальной оценки и без скриншотов.

### 8.2) Расширенный режим (только по явному запросу)
1. Baseline-скриншоты в Telegram `fullscreen`:
   - 360x780
   - 390x844
   - 430x932
2. Реализация.
3. After-скриншоты в тех же размерах.
4. Сравнение до/после.
5. Строгая оценка 0–100.
6. Исправление регрессий в той же итерации.
7. Если <90 — еще одна итерация улучшений.

Рекомендуемые команды:
```bash
npm run screenshot:tg-2026-fullscreen -- --width 360 --height 780 --outDir .logs/design-baseline-360
npm run screenshot:tg-2026-fullscreen -- --width 390 --height 844 --outDir .logs/design-baseline-390
npm run screenshot:tg-2026-fullscreen -- --width 430 --height 932 --outDir .logs/design-baseline-430
```

## 9) Модель оценки качества (0–100)
Используется только если пользователь явно просит оценку.
- 22: визуальная иерархия и ясность CTA.
- 18: мобильная плотность и скорость сканирования.
- 18: консистентность состояний и флоу.
- 14: типографика, отступы, аккуратность.
- 14: оригинальность и характер интерфейса.
- 8: прозрачность экономики (что/когда списано и начислено).
- 6: safe-area, Telegram chrome, тач-таргеты.

Интерпретация:
- 95–100: top-tier;
- 90–94: сильно, но можно точечно усилить;
- 80–89: рабоче, но ниже стандарта 2026;
- <80: требуется переработка.

## 10) Обязательная самокритика агента
- Для каждого дефекта: `проблема -> риск -> исправление -> проверка`.
- Приоритет:
  1. критичные мобильные/экономические/безопасностные;
  2. логические и статусные;
  3. визуальные.
- Если дефект устраним в текущем цикле, агент обязан устранить его сразу.

## 11) Политика текста в mobile UI
- Никаких длинных блоков текста в карточках/модалках.
- Подсказки короткие, контекстные, рядом с действием.
- Использовать progressive disclosure.
- Формулировки баллов/бюджетов/остатка должны быть однозначными и грамматически корректными.

## 12) Telegram Mini App ограничения
- Учитывать safe-area и fullscreen-поведение.
- Не размещать критичные элементы в зоне нижних конфликтов.
- Telegram Main Button и системные слои приложением не контролируются.
- Только mobile-first.

## 13) UX-симметрия режимов
- Исполнитель и рекламодатель должны видеть согласованные статусы и последствия действий.
- Причина блокировки CTA должна быть понятна и локально объяснена.
- Изменения баланса должны быть ожидаемыми и проверяемыми пользователем.

## 14) Edge cases (обязательный минимум)
- недостаточный баланс;
- почти пустой remaining budget;
- повторная заявка на кампанию;
- race-condition по статусам;
- revoke/штраф/модерация;
- битая ссылка на пост/канал;
- блокировка пользователя.

## 15) Ответы и отчетность агента
- Всегда отвечать на русском.
- После изменений указывать:
  - что изменено;
  - какие файлы затронуты;
  - что проверено (`npm run build` минимум).
- Скриншоты и формальная оценка — только по явному запросу.
- Блок `Самокритика` (>=3 пункта) обязателен в расширенном UI-отчете.

## 16) Если пользователь просит план
- Сначала анализ контекста проекта.
- Затем пошаговый план.
- До явного подтверждения — без кодовых изменений (кроме безопасного анализа).

## 17) Режим уточнения для неточных запросов
Если запрос двусмысленный или слишком общий, использовать:
`Мысль -> Промт -> Варианты -> Что подтверждаете`.

До подтверждения:
- не делать рискованные изменения;
- выполнять только безопасный анализ.
