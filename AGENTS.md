# AGENTS.md — StockMarket (Telegram Mini App, 2026 Standard)

## 1) Главная мысль
- Агент работает как mobile/product-эксперт уровня top-tier сервиса 2026 и улучшает продукт до конкурентного уровня, а не до "минимально рабочего".
- Проект: биржа взаимных действий в Telegram (вступления в группы/каналы и реакции на посты) с внутренней экономикой баллов.
- Любые решения оцениваются по влиянию на скорость сценариев, понятность действий, доверие к начислениям/списаниям и устойчивость флоу.
- По умолчанию UI-задачи выполняются в быстром режиме: без скриншотов и без формальной оценки, если пользователь явно не просил сравнение/оценку.

## 2) Product Snapshot
- Формат: Telegram Mini App, только мобильные устройства.
- Целевая ширина: 360–430px.
- Язык интерфейса: русский.
- Доменные роли в продукте:
  - `исполнитель`: берет задания, выполняет действие в Telegram, подтверждает и получает баллы;
  - `рекламодатель`: размещает кампании (подписка/реакции), настраивает бюджет, получает выполнение;
  - `админ`: следит за рисками, жалобами, stale-заявками и экономикой.
- Важное: это не маркетплейс `client/master` и не сервис бронирований.

### 2.1) Ключевые пользовательские флоу
- Авторизация через Telegram init data.
- Главная: баланс, прогресс ранга, быстрые CTA.
- Продвижение (`promo`): запуск кампаний через wizard (3 шага для `subscribe`, 4 шага для `reaction`).
- Задания (`tasks`): лента заданий, фильтры, статусы, подтверждение награды, история.
- Daily Bonus (`wheel`): ежедневное колесо с cooldown и streak.
- Рефералы (`referrals`): код/ссылка, прогресс по milestone, список приглашенных.
- Админ (`admin`): panel stats, moderation, cleanup stale-заявок, unblock.

### 2.2) Целевой уровень продукта
- Приоритет: нативное mobile-ощущение, быстрый отклик, четкая иерархия, предсказуемые состояния.
- Минимальные тач-таргеты: 44x44 (предпочтительно 46–48 для критичных кнопок).
- Никаких desktop-раскладок и растянутых веб-паттернов.
- Баланс между компактностью и читаемостью обязателен: плотный UI без шума.

### 2.3) Приоритет качества над наследием
- Если текущая реализация мешает top-tier UX или надежности экономики, агент пересобирает блок целиком.
- Разрешено менять frontend/backend/схему/API при доказуемой пользе и контроле рисков.
- Критерий приемки: реальное улучшение UX, скорости сценария, прозрачности баллов и устойчивости системы.

### 2.4) Автономная работа агента
- Режим работы: анализ -> реализация -> проверка -> самокритика -> доработка.
- Не задавать лишние вопросы при отсутствии блокера/риска потери данных.
- Любой найденный дефект оформлять как: `проблема -> риск -> исправление -> проверка`.
- Остановка: достигнут целевой уровень или пользователь явно остановил.

## 3) Архитектура и Source of Truth
- Frontend: React + TypeScript + Vite.
  - Основной экран: `tg-mini/src/App.tsx`
  - Стили: `tg-mini/src/styles.css`
  - Типы API: `tg-mini/src/types/app.ts`
- Backend: Fastify + Prisma + MySQL.
  - Точка входа: `server/src/index.ts`
  - Основные API/правила: `server/src/routes.ts`
  - Доменные правила: `server/src/domain/economy.ts`, `server/src/domain/daily-bonus.ts`, `server/src/domain/moderation.ts`
  - Схема БД: `server/prisma/schema.prisma`
- Telegram-интеграции: `server/src/telegram.ts`, `server/src/telegram-bot.ts`, `server/src/telegram-webhook.ts`
- Визуальные инструменты: `tg-mini/scripts/miniapp-visual.mjs`
- API base: `VITE_API_URL` или `VITE_API_BASE` (fallback: same-origin `/api`).

## 4) Доменные инварианты (обязательно учитывать)
- Один пользователь может быть и исполнителем, и рекламодателем.
- Тип кампании только `SUBSCRIBE` или `REACTION`.
- Ключевые статусы:
  - кампании: `ACTIVE | PAUSED | COMPLETED`;
  - заявки: `PENDING | APPROVED | REJECTED | REVOKED`.
- Экономика баллов:
  - при создании кампании бюджет списывается;
  - при `APPROVED` начисляется payout исполнителю и уменьшается remaining budget;
  - все движения должны быть отражены в ledger;
  - штрафы/ревоки и модерация не должны ломать консистентность баланса.
- Рефералы работают по milestone-модели (`JOIN`, `ORDERS_5`, `ORDERS_15`, `ORDERS_30`).
- Daily bonus ограничен cooldown, учитывается streak.

## 5) Базовая стратегия реализации
1. Проверить затронутые экраны, типы, API и доменные правила.
2. Изменить backend (валидация, бизнес-логика, схемы) при необходимости.
3. Синхронизировать frontend (типы, API calls, state, UI, optimistic updates).
4. Проверить ключевые состояния (loading/empty/error/success/edge).
5. Запустить обязательную проверку: `npm run build` (минимум для `tg-mini`, при backend-изменениях также сборка/тесты backend).
6. Провести самокритику и сразу устранить найденные дефекты без ожидания отдельного запроса.

## 6) Процесс для UI/верстки/дизайна
Применяется для любых визуальных изменений.

### 6.1) Режим по умолчанию (быстрый)
1. Внести изменения.
2. Локально проверить критичные состояния и сценарий целиком.
3. Выполнить `npm run build`.
4. Кратко отчитаться без скриншотов и без формальной оценки.

### 6.2) Расширенный режим (если пользователь явно просит скриншоты/оценку)
1. Снять baseline-скриншоты в Telegram `fullscreen`:
   - 360x780
   - 390x844
   - 430x932
2. Реализовать изменения.
3. Снять after-скриншоты в тех же размерах.
4. Сравнить до/после по каждому экрану.
5. Дать строгую оценку 0–100.
6. Исправить регрессии в том же цикле.
7. Если <90/100, сделать минимум еще одну итерацию улучшений (если пользователь не остановил).

Рекомендуемые команды:
```bash
npm run screenshot:tg-2026-fullscreen -- --width 360 --height 780 --outDir .logs/design-baseline-360
npm run screenshot:tg-2026-fullscreen -- --width 390 --height 844 --outDir .logs/design-baseline-390
npm run screenshot:tg-2026-fullscreen -- --width 430 --height 932 --outDir .logs/design-baseline-430
```

## 7) Правила оценки дизайна (0–100, строго)
Используются только при явном запросе оценки.
- 25: визуальная иерархия, читаемость, ясность главного CTA.
- 20: плотность и мобильная компактность без перегруза.
- 20: консистентность состояний (loading/empty/error/success).
- 15: качество типографики, ритм отступов, аккуратность деталей.
- 10: прозрачность экономики (что списывается/начисляется и когда).
- 10: отсутствие конфликтов с Telegram safe-area/chrome и тач-таргетами.

Интерпретация:
- 95–100: top-tier;
- 90–94: сильно, но есть точечные улучшения;
- 80–89: приемлемо, но ниже уровня 2026;
- <80: требуется переработка.

## 8) Проактивный поиск дефектов
- Агент обязан находить и исправлять дефекты, даже если пользователь их не перечислил.
- Приоритет дефектов:
  1. критичные мобильные/экономические/безопасностные;
  2. логические и статусные;
  3. визуальные.
- Нельзя останавливаться на описании проблемы, если ее можно исправить в текущем цикле.

## 9) Политика текста в мобильном UI
- Избегать длинных текстов и "простыней".
- Подсказки: коротко, 1–2 строки, рядом с действием.
- Использовать progressive disclosure вместо перегрузки карточек.
- Для баллов/бюджетов формулировки должны быть максимально однозначными.

## 10) Telegram Mini App ограничения
- Учитывать safe-area, fullscreen-режим и Telegram chrome.
- Не ставить критичные CTA в зонах конфликта нижнего края.
- Учитывать, что Telegram Main Button и системные слои не контролируются приложением.
- Только mobile-first.

## 11) UX-симметрия режимов
- Флоу исполнителя и рекламодателя должны быть логически согласованы:
  - статусы кампаний/заявок должны совпадать между списками, карточками и действиями;
  - причины блокировки CTA должны быть явны;
  - изменения баланса должны быть предсказуемыми для обеих сторон.

## 12) Состояния и edge cases
- Для ключевых блоков обязательны: loading, empty, error, success, edge cases.
- Особые edge cases:
  - недостаточный баланс;
  - нулевой/почти нулевой remaining budget;
  - повторное применение к кампании;
  - конфликт статусов при race-condition;
  - revoke/штраф/модерация;
  - битая ссылка на пост/канал;
  - блокировка пользователя.

## 13) Ответы и отчетность агента
- Всегда отвечать на русском.
- После изменений указывать:
  - что изменено;
  - какие файлы затронуты;
  - что проверено (`npm run build` минимум).
- Скриншоты и формальная оценка — только если пользователь явно запросил.
- `Самокритика` (>=3 пункта) обязательна только в расширенном UI-отчете с оценкой.

## 14) Если пользователь просит план
- Сначала анализ проекта.
- Затем пошаговый план.
- До явного подтверждения пользователя код не менять (кроме безопасного анализа).

## 15) Режим уточнения для неточных запросов
Если запрос двусмысленный или слишком общий, использовать формат:
`Мысль -> Промт -> Варианты -> Что подтверждаете`.

До подтверждения:
- не вносить рискованные изменения;
- выполнять только безопасный анализ контекста.
