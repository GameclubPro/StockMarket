datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum CampaignType {
  SUBSCRIBE
  REACTION
}

enum CampaignReportReason {
  SPAM_SCAM
  FAKE_TASK
  BROKEN_LINK
  PROHIBITED_CONTENT
  OTHER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum LedgerType {
  EARN
  SPEND
  REFUND
  ADJUST
}

enum ReferralRewardSide {
  REFERRER
  REFERRED
}

enum ReferralMilestone {
  JOIN
  ORDERS_5
  ORDERS_15
  ORDERS_30
}

model User {
  id         String   @id @default(cuid())
  telegramId String   @unique
  username   String?
  firstName  String?
  lastName   String?
  photoUrl   String?
  balance    Int      @default(30)
  totalEarned Int     @default(0)
  rating     Float    @default(0)
  referralCode String? @unique
  firstAuthAt DateTime?
  createdAt  DateTime @default(now())

  groups       Group[]
  groupAdmins  GroupAdmin[]
  campaigns    Campaign[]
  hiddenCampaigns HiddenCampaign[]
  campaignReports CampaignReport[]
  applications Application[]
  ledger       LedgerEntry[]
  referrals    Referral[] @relation("ReferralReferrer")
  referralFrom Referral?  @relation("ReferralReferred")
}

model Group {
  id          String   @id @default(cuid())
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  title       String
  username    String?  @unique
  telegramChatId String? @unique
  inviteLink  String
  description String?
  category    String?
  createdAt   DateTime @default(now())

  campaigns   Campaign[]
  admins      GroupAdmin[]
}

model GroupAdmin {
  groupId   String
  userId    String
  createdAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([groupId, userId])
}

model Campaign {
  id              String         @id @default(cuid())
  groupId         String
  ownerId         String
  group           Group          @relation(fields: [groupId], references: [id])
  owner           User           @relation(fields: [ownerId], references: [id])
  actionType      CampaignType   @default(SUBSCRIBE)
  targetMessageId Int?
  reactionCount   Int?
  rewardPoints    Int
  totalBudget     Int
  remainingBudget Int
  status          CampaignStatus @default(ACTIVE)
  createdAt       DateTime       @default(now())

  applications    Application[]
  ledgerEntries   LedgerEntry[]
  hiddenByUsers   HiddenCampaign[]
  reports         CampaignReport[]

  @@index([ownerId, createdAt])
  @@index([status, remainingBudget, createdAt])
}

model HiddenCampaign {
  userId     String
  campaignId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@id([userId, campaignId])
  @@index([campaignId, createdAt])
}

model CampaignReport {
  id         String               @id @default(cuid())
  campaignId String
  reporterId String
  reason     CampaignReportReason
  reportedAt DateTime             @default(now())
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  campaign   Campaign             @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  reporter   User                 @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@unique([campaignId, reporterId])
  @@index([reportedAt])
  @@index([campaignId, reportedAt])
  @@index([reporterId, reportedAt])
}

model Application {
  id          String            @id @default(cuid())
  campaignId  String
  applicantId String
  status      ApplicationStatus @default(PENDING)
  reactionBaseline Int?
  createdAt   DateTime          @default(now())
  reviewedAt  DateTime?

  campaign    Campaign          @relation(fields: [campaignId], references: [id])
  applicant   User              @relation(fields: [applicantId], references: [id])

  @@unique([campaignId, applicantId])
  @@index([applicantId, createdAt])
  @@index([campaignId, status, createdAt])
}

model LedgerEntry {
  id         String     @id @default(cuid())
  userId     String
  type       LedgerType
  amount     Int
  reason     String
  campaignId String?
  createdAt  DateTime   @default(now())

  user       User       @relation(fields: [userId], references: [id])
  campaign   Campaign?  @relation(fields: [campaignId], references: [id])

  @@index([userId, reason, createdAt])
  @@index([campaignId, createdAt])
}

model Referral {
  id             String   @id @default(cuid())
  referrerId     String
  referredUserId String   @unique
  completedOrders Int     @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  referrer      User            @relation("ReferralReferrer", fields: [referrerId], references: [id])
  referredUser  User            @relation("ReferralReferred", fields: [referredUserId], references: [id])
  rewards       ReferralReward[]

  @@index([referrerId, createdAt])
}

model ReferralReward {
  id         String             @id @default(cuid())
  referralId String
  side       ReferralRewardSide
  milestone  ReferralMilestone
  amount     Int
  rewardedAt DateTime           @default(now())

  referral   Referral           @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@unique([referralId, side, milestone])
}

model BotPanelAccess {
  id         String   @id @default(cuid())
  telegramId String?  @unique
  username   String?  @unique
  isEnabled  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isEnabled, createdAt])
}
